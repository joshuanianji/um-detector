<!DOCTYPE html>

<html>

<head>
  <title>Voice Recorder</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css" />
  <link rel="stylesheet" href="index.css">
  <script src="./dist/recorder.min.js"></script>
  <script src="recorder.min.js"></script>
</head>

<body>

  <div class="box">
    <h1 class = "title">Voice Recorder</h1>
    <p class = "instructions">Hit start to start recording, pause at anytime, and stop whenever you're done.</p>
    <div class="buttons">
    <button id="start" class="button is-success is-small" disabled>Start</button>
    <button id="pause" class="button is-secondary is-small" disabled>Pause</button>
    <button id="resume" class="button is-secondary is-small" disabled>Resume</button>
    <button id="stopButton" class="button is-danger is-small" disabled>Stop</button>
    </div>

    <script>
      const { writeFile } = require('fs');
      if (!Recorder.isRecordingSupported()) {
        console.log("Recording features are not supported in your browser.");
      }

      else {
        start.disabled = false;

        var options = {
          monitorGain: 0,
          recordingGain: 1,
          numberOfChannels: 1,
          encoderSampleRate: 16000,
          wavBitDepth: 16,
          encoderPath: "waveWorker.min.js"
          // sourceNode: sourceNode
        };

        var recorder = new Recorder(options);

        var recorderPause = function () { recorder.pause(); };
        var recorderStop = function () { recorder.stop(); };
        var recorderResume = function () { recorder.resume(); };
        var recorderStart = function () {
          recorder.start().catch(function (e) {
            console.log('Error encountered:', e.message);
          });
        };

        pause.addEventListener("click", recorderPause);
        resume.addEventListener("click", recorderResume);
        stopButton.addEventListener("click", recorderStop);
        start.addEventListener("click", recorderStart);

        recorder.onstart = function (e) {
          console.log('Recorder is started');
          start.disabled = resume.disabled = true;
          pause.disabled = stopButton.disabled = false;
        };

        recorder.onstop = function (e) {
          console.log('Recorder is stopped');
          start.disabled = false;
          pause.disabled = resume.disabled = stopButton.disabled = true;
        };

        recorder.onpause = function (e) {
          console.log('Recorder is paused');
          pause.disabled = start.disabled = true;
          resume.disabled = stopButton.disabled = false;
        };

        recorder.onresume = function (e) {
          console.log('Recorder is resuming');
          start.disabled = resume.disabled = true;
          pause.disabled = stopButton.disabled = false;
        };

        recorder.ondataavailable = function( typedArray ){
            console.log('Data received');
            var dataBlob = new Blob( [typedArray], { type: 'audio/wav' } );
            var fileName = new Date().getTime() + ".wav";

            var file = new File([dataBlob], fileName);

            var formData = new FormData();
            var formResults;
            formData.append('file', file);
            fetch(`http://34.68.110.162/upload`, {method:"POST", body:formData})
              .then(response => response.json())
              .then(data => {
                console.log(data);
                //formResults = data;
                //console.log(formResults);
                iframe.arr = data;
                console.log(iframe.arr);
                var myWindow = window.open('statistics.html');
                myWindow.arr = data;
                console.log(myWindow.arr);
                document.getElementById('p').innerHTML = JSON.stringify(data);
              })
              .catch(err => {
                  alert(err);
              });

          }
        };


    </script>

    <div id = "output"></div>
    <script>
        const testData = {"articulation_rate":3.0,"balance":0.8,"f0_max":287.0,"f0_mean":153.92,"f0_median":139.5,"f0_min":79.0,"f0_quan75":190.0,"f0_quantile25":114.0,"f0_std":49.35,"gender":{"gender":"male","mood":"passionate","p":2.180743305984188e-139,"sample":5},"number_ of_syllables":115.0,"number_of_pauses":9.0,"original_duration":45.8,"pronounciation_score":79.995,"rate_of_speech":3.0,"speaking_duration":38.1};
        const usefulData = ["articulation_rate", "number_ of_syllables", "rate_of_speech"];

        const bodyDiv = document.getElementById('output');
        usefulData.forEach( key => {
            const content = document.createElement('div');
            content.innerHTML = key +': '+ testData[key];
            bodyDiv.appendChild(content);
        });
    </script>
  </div>

  <div class="box">
    <h1>Enter your video call link here:</h1>
    <input id="url" class="is-success is-rounded" />
    <button id="submitUrl">Submit</button>

    <script>
      submitUrl.addEventListener('click', function(){
        MyWindow = window.open(url.value.toString(), 'MyWindow', 'width=800, height=600');
      });
    </script>

    <button id="viewStatsButton">View Statistics</button>
  </div>

  

  <script>
    function setUpFrame() {
      console.log(window.frames['iframe']);
      var frame = window.frames['iframe'];

      //frame.arr = document.getElementById('start').arr;
      frame.setUp(this.arr);
    }

    viewStatsButton.addEventListener('click', function(){
      iframe.hidden = false;
    })


  </script>
  <div>
    <iframe id="iframe" src="statistics.html" hidden>
    </iframe>
  </div>

  <script>
  console.log(iframe.arr);
  </script>

  <p id="boom"></p>

</body>

</html>
